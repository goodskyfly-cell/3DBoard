<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FIBA 3D æˆ°è¡“æ¿ - å°ˆæ¥­ç¾åŒ–ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* UI ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        #ui-left { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            width: 220px; 
            max-height: 90vh; 
            overflow-y: auto; 
            padding: 20px;
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); /* ç£¨ç ‚ç»ç’ƒé—œéµ */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            color: white;
        }

        /* è‡ªå®šç¾©æ²å‹•æ¢ */
        #ui-left::-webkit-scrollbar { width: 4px; }
        #ui-left::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        button { 
            padding: 12px; 
            font-size: 13px; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            background: #ffffff;
        }

        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

        /* ç‰¹å®šåŠŸèƒ½é¡è‰² */
        .btn-rec { background: #ff4757; color: white; }
        .btn-rec:hover { background: #ff6b81; }
        .btn-next { background: #ffa502; color: white; display: none; }
        .btn-play { background: #2ed573; color: white; }
        .btn-mode { background: #1e90ff; color: white; }
        .btn-reset { background: #f1f2f6; color: #2f3542; }
        .btn-action { background: rgba(255, 255, 255, 0.2); color: white; font-size: 11px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-action:hover { background: rgba(255, 255, 255, 0.3); }

        select { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.2); 
            font-size: 13px; 
            background: rgba(0, 0, 0, 0.3); 
            color: white; 
            outline: none;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #1e90ff;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }

        #status { position: absolute; bottom: 25px; width: 100%; text-align: center; color: rgba(255,255,255,0.8); pointer-events: none; font-size: 14px; letter-spacing: 1px; z-index: 50; }
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 8px 0; }
        .label { color: rgba(255,255,255,0.6); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="ui-left">
        <div class="label">è¦–è§’åˆ‡æ›</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button onclick="changeView('top')">é³¥ç°</button>
            <button onclick="changeView('side')">æ­£é¢</button>
            <button onclick="changeView('45left')">å·¦45Â°</button>
            <button onclick="changeView('45right')">å³45Â°</button>
        </div>
        
        <hr>
        <div class="label">æ“ä½œæ¨¡å¼</div>
        <button id="modeBtn" class="btn-mode" onclick="toggleControlMode()">ğŸ“ ç‰©ä»¶æ‹–æ‹½</button>
        
        <hr>
        <div class="label">æˆ°è¡“éŒ„è£½</div>
        <button id="recBtn" class="btn-rec" onclick="toggleRecording()">â— é–‹å§‹éŒ„è£½</button>
        <button id="nextBtn" class="btn-next" onclick="recordNextStage()">ï¼‹ ä¸‹ä¸€æ ¼</button>
        
        <div class="label">æ’­æ”¾é€Ÿåº¦: <span id="speedVal" style="color:#1e90ff">1.0</span>x</div>
        <input type="range" id="speedRange" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateSpeedDisplay()">
        
        <button id="playBtn" class="btn-play" onclick="playFullTactic()" disabled>â–¶ æ’­æ”¾æˆ°è¡“</button>
        <button class="btn-reset" onclick="resetPositions()">â†º é‡è¨­ä½ç½®</button>
        
        <hr>
        <div class="label">æˆ°è¡“æ¸…å–®</div>
        <select id="tacticSelect" onchange="selectTactic()">
            <option value="">-- é¸æ“‡æˆ°è¡“ --</option>
        </select>
        <button class="btn-action" onclick="saveTacticToLib()">ğŸ’¾ å‘½åå„²å­˜</button>
        <button class="btn-action" onclick="deleteTactic()">ğŸ—‘ åˆªé™¤é¸å–</button>
        
        <hr>
        <div class="label">ç³»çµ±</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn-action" onclick="exportToFile()">ğŸ“¤ åŒ¯å‡º</button>
            <button class="btn-action" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥</button>
        </div>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importFromFile(event)">
    </div>

    <div id="status">ç³»çµ±æº–å‚™å°±ç·’</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ... æ­¤è™•è²¼ä¸ŠåŸæœ¬çš„ JavaScript ä»£ç¢¼é‚è¼¯ ...
        // (ç‚ºäº†é•·åº¦è€ƒé‡ï¼Œè«‹å°‡åŸæœ¬ init, animate, æ‰€æœ‰çš„ window. å‡½å¼è²¼å›æ­¤è™•)
        // ç¢ºä¿è¦–çª—ç¸®æ”¾é‚è¼¯ä¾ç„¶å­˜åœ¨ï¼š
        /*
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        */
        
        // [è¨»ï¼šè«‹å°‡å‰ä¸€ç‰ˆçš„ JS å®Œæ•´å…§å®¹æ”¾é€²é€™è£¡ï¼ŒåŒ…å« init, animate, onMouseDown ç­‰]
        // é€™è£¡åƒ…åˆ—å‡ºå¿…è¦çš„è®Šæ•¸åˆå§‹åŒ–ç¢ºä¿é‹ä½œ
        let scene, camera, renderer, controls, movableObjects = [], clickTargets = [], stages = [], initialPositions = [];
        let isPlaying = false, playStartTime = 0, isDragMode = true, tacticLibrary = {}, playSpeed = 1.0;
        const raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2(), plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0), intersection = new THREE.Vector3(), offset = new THREE.Vector3();
        let selectedObject = null;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 18, 25);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enabled = false;
            scene.add(new THREE.AmbientLight(0xffffff, 2.5));
            scene.add(createFIBAField());
            addHoop(14, 0); addHoop(-14, 0);
            for(let i=1; i<=5; i++) {
                createPlayer(-7, -6 + i*2.2, 0xcc0000, i.toString());
                createPlayer(7, -6 + i*2.2, 0x0000cc, i.toString());
            }
            createBall(0, 0);
            initialPositions = movableObjects.map(g => ({ x: g.position.x, z: g.position.z }));
            loadLibFromStorage();
            window.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- åŠŸèƒ½å‡½å¼ ---
        window.updateSpeedDisplay = () => {
            playSpeed = parseFloat(document.getElementById('speedRange').value);
            document.getElementById('speedVal').innerText = playSpeed.toFixed(1);
        };
        window.resetPositions = () => {
            if(isPlaying) return;
            movableObjects.forEach((g, i) => {
                g.position.set(initialPositions[i].x, 0, initialPositions[i].z);
            });
            document.getElementById('status').innerText = "ä½ç½®å·²é‡è¨­";
        };
        window.saveTacticToLib = () => {
            if (stages.length < 2) return alert("è«‹å…ˆéŒ„è£½å‹•ä½œ");
            const name = prompt("æˆ°è¡“åç¨±ï¼š");
            if (name) { tacticLibrary[name] = stages; updateTacticSelect(); saveLibToStorage(); }
        };
        window.selectTactic = () => {
            const name = document.getElementById('tacticSelect').value;
            if (name && tacticLibrary[name]) {
                stages = tacticLibrary[name];
                document.getElementById('playBtn').disabled = false;
                movableObjects.forEach((g, i) => g.position.set(stages[0][i].x, 0, stages[0][i].z));
                document.getElementById('status').innerText = `å·²é¸å–ï¼š${name}`;
            }
        };
        window.deleteTactic = () => {
            const name = document.getElementById('tacticSelect').value;
            if (name && confirm("åˆªé™¤ï¼Ÿ")) { delete tacticLibrary[name]; updateTacticSelect(); saveLibToStorage(); }
        };
        window.exportToFile = () => {
            const blob = new Blob([JSON.stringify(tacticLibrary)], {type:"application/json"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "tactics.json"; a.click();
        };
        window.importFromFile = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { tacticLibrary = {...tacticLibrary, ...JSON.parse(ev.target.result)}; updateTacticSelect(); saveLibToStorage(); };
            reader.readAsText(e.target.files[0]);
        };
        function updateTacticSelect() {
            const s = document.getElementById('tacticSelect');
            s.innerHTML = '<option value="">-- é¸æ“‡æˆ°è¡“ --</option>';
            Object.keys(tacticLibrary).forEach(n => { const o = document.createElement('option'); o.value = n; o.innerText = n; s.appendChild(o); });
        }
        function saveLibToStorage() { localStorage.setItem('fiba_tactic_lib', JSON.stringify(tacticLibrary)); }
        function loadLibFromStorage() { const d = localStorage.getItem('fiba_tactic_lib'); if(d){ tacticLibrary = JSON.parse(d); updateTacticSelect(); } }

        window.toggleControlMode = () => {
            isDragMode = !isDragMode;
            const btn = document.getElementById('modeBtn');
            btn.innerText = isDragMode ? "ğŸ“ ç‰©ä»¶æ‹–æ‹½" : "ğŸ¥ è¦–è§’æ—‹è½‰";
            btn.style.background = isDragMode ? "#1e90ff" : "#8e44ad";
            controls.enabled = !isDragMode;
        };
        window.toggleRecording = () => {
            const btn = document.getElementById('recBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (btn.innerText.includes("é–‹å§‹")) {
                stages = []; recordNextStage();
                btn.innerText = "â–  çµæŸéŒ„è£½"; nextBtn.style.display = "block";
            } else {
                btn.innerText = "â— é–‹å§‹éŒ„è£½"; nextBtn.style.display = "none";
                document.getElementById('playBtn').disabled = stages.length < 2;
            }
        };
        window.recordNextStage = () => {
            stages.push(movableObjects.map(g => ({ x: g.position.x, z: g.position.z })));
            document.getElementById('status').innerText = `å·²ç´€éŒ„ç¬¬ ${stages.length} æ ¼`;
        };
        window.playFullTactic = () => { if(stages.length >= 2){ isPlaying = true; playStartTime = Date.now(); } };

        function animate() {
            requestAnimationFrame(animate);
            if (isPlaying) {
                const progress = ((Date.now() - playStartTime) / 1000) * playSpeed;
                const idx = Math.floor(progress);
                const ratio = progress - idx;
                if (idx < stages.length - 1) {
                    movableObjects.forEach((g, i) => {
                        g.position.x = stages[idx][i].x + (stages[idx+1][i].x - stages[idx][i].x) * ratio;
                        g.position.z = stages[idx][i].z + (stages[idx+1][i].z - stages[idx][i].z) * ratio;
                    });
                } else { isPlaying = false; }
            }
            controls.update();
            renderer.render(scene, camera);
        }

        // --- æ‹–æ‹½é‚è¼¯ (MouseDown/Move/Up) ---
        function onMouseDown(event) {
            if (!isDragMode || isPlaying) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickTargets);
            if (intersects.length > 0) {
                selectedObject = intersects[0].object.parent; 
                if (raycaster.ray.intersectPlane(plane, intersection)) offset.copy(intersection).sub(selectedObject.position);
            }
        }
        function onMouseMove(event) {
            if (!selectedObject) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.ray.intersectPlane(plane, intersection)) selectedObject.position.copy(intersection.sub(offset)).y = 0;
        }
        function onMouseUp() { selectedObject = null; }

        // --- çƒå ´èˆ‡çƒå“¡å»ºç«‹ (åŒå‰ç‰ˆ) ---
        function createFIBAField() {
            const canvas = document.createElement('canvas'); canvas.width = 2800; canvas.height = 1500;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#bc9b70'; ctx.fillRect(0, 0, 2800, 1500);
            ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 12; ctx.strokeRect(0, 0, 2800, 1500);
            ctx.beginPath(); ctx.moveTo(1400, 0); ctx.lineTo(1400, 1500); ctx.stroke();
            ctx.beginPath(); ctx.arc(1400, 750, 180, 0, Math.PI * 2); ctx.stroke();
            [0, 2800].forEach(x => {
                const d = x === 0 ? 1 : -1; ctx.strokeRect(x, 505, 580 * d, 490);
                ctx.beginPath(); ctx.arc(x + 580 * d, 750, 180, -Math.PI/2, Math.PI/2, x !== 0); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x, 90); ctx.lineTo(x + 299 * d, 90); 
                ctx.arc(x + 157.5 * d, 750, 675, -1.39, 1.39, x !== 0); ctx.lineTo(x, 1410); ctx.stroke();
            });
            const tex = new THREE.CanvasTexture(canvas);
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(28, 15), new THREE.MeshLambertMaterial({ map: tex }));
            mesh.rotation.x = -Math.PI / 2; return mesh;
        }
        function createBall(x, z) {
            const g = new THREE.Group(); const b = new THREE.Mesh(new THREE.SphereGeometry(0.2, 32, 32), new THREE.MeshPhongMaterial({ color: 0xff6600 }));
            b.position.y = 0.2; g.add(b); clickTargets.push(b); g.position.set(x, 0, z); scene.add(g); movableObjects.push(g);
        }
        function createPlayer(x, z, color, num) {
            const g = new THREE.Group(); const b = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 0.8, 4, 8), new THREE.MeshPhongMaterial({ color }));
            b.position.y = 0.4; g.add(b); clickTargets.push(b);
            const nc = document.createElement('canvas'); nc.width = 64; nc.height = 64;
            const nx = nc.getContext('2d'); nx.fillStyle = 'white'; nx.font = 'bold 40px Arial'; nx.textAlign = 'center'; nx.fillText(num, 32, 45);
            const s = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(nc) }));
            s.position.y = 1.4; s.scale.set(0.8, 0.8, 1); g.add(s); g.position.set(x, 0, z); scene.add(g); movableObjects.push(g);
        }
        function addHoop(bx, z) {
            const g = new THREE.Group(); const p = new THREE.Mesh(new THREE.BoxGeometry(0.3, 4, 0.3), new THREE.MeshPhongMaterial({ color: 0x222222 }));
            p.position.set(0.5 * (bx > 0 ? 1 : -1), 2, 0); g.add(p);
            const bb = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.2, 1.8), new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 }));
            bb.position.set(-1.2 * (bx > 0 ? 1 : -1), 3.2, 0); g.add(bb);
            const r = new THREE.Mesh(new THREE.TorusGeometry(0.22, 0.03, 12, 24), new THREE.MeshPhongMaterial({ color: 0xff4400 }));
            r.rotation.x = Math.PI/2; r.position.set(-1.575 * (bx > 0 ? 1 : -1), 3.05, 0); g.add(r);
            g.position.set(bx, 0, z); scene.add(g);
        }
        window.changeView = (v) => {
            if(v === 'top') camera.position.set(0, 32, 0);
            if(v === 'side') camera.position.set(0, 18, 25);
            if(v === '45left') camera.position.set(-22, 16, 18);
            if(v === '45right') camera.position.set(22, 16, 18);
            controls.target.set(0,0,0); controls.update();
        };
    </script>
</body>
</html>
